name: Release (Proton-GE Manager — Linux AppImage)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name to publish (e.g., v0.4.0). Required when running manually if not on a tag."
        required: false
        type: string
      prerelease:
        description: "Mark release as prerelease?"
        required: false
        type: boolean
        default: false
  release:
    types: [created]

permissions:
  contents: write
  id-token: write

env:
  APP_ID:   com.siirrandall.protonge.manager
  APP_NAME: Proton-GE Manager
  ICON_PATH: ./internal/assets/icon.png
  SRC_DIR: ./cmd/proton-ge-manager
  GO_VERSION: "1.22.12"

jobs:
  build-appimage:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install build deps (GL/X11, tools)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gcc pkg-config \
            libgl1-mesa-dev xorg-dev \
            libxrandr-dev libxxf86vm-dev libxi-dev libxcursor-dev libxinerama-dev \
            libfuse2 wget curl desktop-file-utils squashfs-tools

      - name: Build linux amd64 binary
        env:
          CGO_ENABLED: "1"
        run: |
          set -euo pipefail
          mkdir -p dist
          cd "$SRC_DIR"
          GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "-s -w" -o ../../dist/proton-ge-manager
          cd ../../dist
          chmod +x proton-ge-manager

      - name: Assemble AppDir
        env:
          APP_ID:   ${{ env.APP_ID }}
          APP_NAME: ${{ env.APP_NAME }}
          ICON_PATH: ${{ env.ICON_PATH }}
        run: |
          set -euo pipefail
          APPDIR="AppDir"
          BIN_NAME="proton-ge-manager"
          DESKTOP_NAME="${APP_ID}.desktop"
          ICON_NAME="${APP_ID}.png"

          rm -rf "${APPDIR}"
          mkdir -p "${APPDIR}/usr/bin"
          mkdir -p "${APPDIR}/usr/share/applications"
          mkdir -p "${APPDIR}/usr/share/icons/hicolor/256x256/apps"

          # Binary
          cp dist/${BIN_NAME} "${APPDIR}/usr/bin/${BIN_NAME}"
          chmod +x "${APPDIR}/usr/bin/${BIN_NAME}"

          # .desktop
          cat > "${APPDIR}/${DESKTOP_NAME}" <<EOF
          [Desktop Entry]
          Type=Application
          Name=${APP_NAME}
          Comment=${APP_NAME}
          Exec=${BIN_NAME}
          Icon=${APP_ID}
          Terminal=false
          Categories=Utility;
          EOF

          # Icon
          if [ -f "${ICON_PATH}" ]; then
            cp "${ICON_PATH}" "${APPDIR}/${ICON_NAME}"
            cp "${ICON_PATH}" "${APPDIR}/usr/share/icons/hicolor/256x256/apps/${ICON_NAME}"
          else
            echo "WARNING: Icon not found at ${ICON_PATH}"
            : > "${APPDIR}/${ICON_NAME}"
          fi
          ln -sf "${ICON_NAME}" "${APPDIR}/.DirIcon" || true

          # Copy desktop file final locations
          cp "${APPDIR}/${DESKTOP_NAME}" "${APPDIR}/usr/share/applications/${DESKTOP_NAME}"

          # AppRun launcher
          cat > "${APPDIR}/AppRun" << 'EOF'
          #!/usr/bin/env sh
          HERE="$(dirname "$(readlink -f "$0")")"
          export PATH="$HERE/usr/bin:$PATH"
          exec "$HERE/usr/bin/proton-ge-manager" "$@"
          EOF
          chmod +x "${APPDIR}/AppRun"

          echo "== desktop-file-validate =="
          desktop-file-validate -v "${APPDIR}/${DESKTOP_NAME}" || true

      - name: Build AppImage
        env:
          APP_NAME: ${{ env.APP_NAME }}
          APP_ID:   ${{ env.APP_ID }}
        run: |
          set -euo pipefail

          # Download latest x86_64 appimagetool
          curl -fsSL --retry 5 --retry-delay 2 --retry-all-errors \
            -o appimagetool \
            "https://github.com/AppImage/AppImageKit/releases/latest/download/appimagetool-x86_64.AppImage"

          chmod +x appimagetool
          ./appimagetool --version || true

          # Sanity checks
          test -x AppDir/AppRun
          test -f "AppDir/${APP_ID}.desktop"
          test -f "AppDir/${APP_ID}.png"

          # Build metadata
          export VERSION="${GITHUB_REF_NAME:-$(date +%Y%m%d)}"

          # Build AppImage
          ./appimagetool -v --no-appstream AppDir "${APP_NAME}.AppImage" 2>&1 | tee appimagetool.log || {
            echo "appimagetool failed -> dumping logs:"
            find AppDir -maxdepth 5 -type f -printf "%M %p\n" | sort
            tail -n 200 appimagetool.log || true
            exit 1
          }

          mkdir -p dist
          chmod +x "${APP_NAME}.AppImage"
          mv "${APP_NAME}.AppImage" dist/proton-ge-manager-linux-x86_64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-amd64
          path: dist/proton-ge-manager-linux-x86_64.AppImage

  publish:
    needs: [build-appimage]
    runs-on: ubuntu-22.04
    env:
      TAG: ${{ github.ref_type == 'tag' && github.ref_name || inputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Fail if tag missing on manual run
        if: ${{ github.ref_type != 'tag' && (inputs.tag == '' || inputs.tag == null) }}
        run: |
          echo "This workflow requires a tag. Provide one via 'Run workflow' → tag (e.g., v1.0.0), or push a tag and trigger this workflow."
          exit 1

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Upload final AppImage to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          generate_release_notes: true
          make_latest: true
          prerelease: ${{ inputs.prerelease == true }}
          files: |
            dist/proton-ge-manager-linux-x86_64.AppImage
